# Implementation Plan: Python 3 Modernization & Tooling Upgrade

**Branch**: `001-python3-modernize-tooling` | **Date**: 2026-01-07 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-python3-modernize-tooling/spec.md`

## Summary

Modernize imap-cli from Python 2.7/3.4 compatibility to Python 3.10+ only, replacing legacy build tooling (setup.py, nose, flake8) with modern equivalents (pyproject.toml, pytest, ruff) managed via uv. This is a tooling migration that preserves all existing functionality while updating the development and testing infrastructure.

## Technical Context

**Language/Version**: Python 3.10+ (minimum 3.10, tested on 3.10, 3.11, 3.12)
**Primary Dependencies**: docopts (CLI argument parsing), existing stdlib dependencies
**Storage**: N/A (CLI tool, no persistent storage)
**Testing**: pytest with pytest-cov for coverage
**Target Platform**: Cross-platform (Linux, macOS, Windows) CLI
**Project Type**: Single project (Python package with CLI entry points)
**Performance Goals**: N/A (CLI tool, not performance-critical)
**Constraints**: Must maintain 90% test coverage, all 10 CLI entry points must continue working
**Scale/Scope**: ~30 Python files, 9 test files, 10 console scripts

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Constitution is not yet configured (template placeholders present). Proceeding with standard Python project best practices:

- ✅ Single package structure (imap_cli/)
- ✅ Tests colocated with source (imap_cli/tests/)
- ✅ CLI entry points via pyproject.toml console_scripts
- ✅ Standard tooling (pytest, ruff, coverage)

No violations to justify.

## Project Structure

### Documentation (this feature)

```text
specs/001-python3-modernize-tooling/
├── plan.md              # This file
├── research.md          # Migration research (what to change)
├── spec.md              # Feature specification
├── checklists/          # Quality checklists
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (existing repository structure - preserved)

```text
imap_cli/                 # Main package
├── __init__.py          # Core IMAP functions (connect, disconnect, etc.)
├── config.py            # Configuration loading
├── const.py             # IMAP constants
├── copy.py              # imap-cli-copy command
├── delete.py            # imap-cli-delete command
├── fetch.py             # imap-cli-read command
├── flag.py              # imap-cli-flag command
├── list_mail.py         # imap-cli-list command
├── search.py            # imap-cli-search command
├── string.py            # String utilities
├── summary.py           # imap-cli-status command
├── scripts/             # Additional scripts
│   ├── imap_api.py      # imap-api command
│   ├── imap_notify.py   # imap-notify command
│   └── imap_shell.py    # imap-shell command
└── tests/               # Test suite (unittest-style, pytest-compatible)
    ├── test_config.py
    ├── test_encoding.py
    ├── test_fetch.py
    ├── test_flag.py
    ├── test_imapcli.py
    ├── test_list_mail.py
    ├── test_search.py
    ├── test_status.py
    └── test_summary.py

# Files to CREATE
pyproject.toml           # NEW: Build configuration, dependencies, tool settings

# Files to MODIFY
tox.ini                  # Update: Python 3.10+, pytest, ruff
CLAUDE.md                # Update: New commands (uv, pytest, ruff)

# Files to DELETE
setup.py                 # Remove: Replaced by pyproject.toml
setup.cfg                # Remove: Replaced by pyproject.toml
requirements.txt         # Remove: Dependencies in pyproject.toml
test-requirements.txt    # Remove: Dev dependencies in pyproject.toml
```

**Structure Decision**: Existing `imap_cli/` package structure is preserved. Tests remain in `imap_cli/tests/`. Only build/tooling configuration files change.

## Complexity Tracking

No complexity violations. This is a straightforward tooling migration:

| Aspect | Current | Target | Complexity |
|--------|---------|--------|------------|
| Build config | setup.py + setup.cfg | pyproject.toml | Low (standard migration) |
| Test runner | nose | pytest | Low (pytest supports unittest) |
| Linter | flake8 + hacking | ruff | Low (ruff replaces both) |
| Package manager | pip | uv | Low (drop-in compatible) |

## Migration Strategy

### Phase 1: Create pyproject.toml (Foundation)

1. Create `pyproject.toml` with:
   - `[build-system]` using hatchling or setuptools
   - `[project]` metadata from setup.py
   - `[project.scripts]` for all 10 console scripts
   - `[project.optional-dependencies]` for dev/test dependencies
   - `[tool.pytest.ini_options]` for pytest configuration
   - `[tool.ruff]` for linter configuration
   - `[tool.coverage]` for coverage settings

2. Verify: `uv pip install -e .` works

### Phase 2: Update Test Infrastructure

1. Remove nose dependency, add pytest + pytest-cov
2. Update test files:
   - Replace `from six.moves import configparser` with `import configparser`
   - Replace `from mock import ...` with `from unittest.mock import ...`
   - Remove any Python 2 compatibility code
3. Verify: `uv run pytest` passes all tests with 90%+ coverage

### Phase 3: Update Linting

1. Configure ruff to match/exceed flake8 rules
2. Run `ruff check --fix` to auto-fix issues
3. Manually fix remaining issues
4. Verify: `uv run ruff check` passes

### Phase 4: Update tox.ini

1. Remove py2 environment
2. Add py310, py311, py312 environments
3. Replace nosetests with pytest
4. Replace flake8 with ruff
5. Verify: `tox` runs successfully

### Phase 5: Cleanup

1. Delete: setup.py, setup.cfg, requirements.txt, test-requirements.txt
2. Update: CLAUDE.md with new commands
3. Verify: Fresh clone + `uv sync` + `uv run pytest` works

## Files Changed Summary

| Action | File | Reason |
|--------|------|--------|
| CREATE | pyproject.toml | Modern build configuration |
| MODIFY | tox.ini | Update to pytest/ruff, Python 3.10+ |
| MODIFY | CLAUDE.md | Update developer commands |
| MODIFY | imap_cli/tests/*.py | Remove six/mock imports |
| MODIFY | imap_cli/*.py | Remove future/six imports if any |
| DELETE | setup.py | Replaced by pyproject.toml |
| DELETE | setup.cfg | Replaced by pyproject.toml |
| DELETE | requirements.txt | Moved to pyproject.toml |
| DELETE | test-requirements.txt | Moved to pyproject.toml |

## Success Verification

After implementation, verify all success criteria from spec:

- [ ] SC-001: `uv run pytest` - all tests pass
- [ ] SC-002: Coverage ≥ 90%
- [ ] SC-003: `uv run ruff check` - no errors
- [ ] SC-004: All 10 console scripts work
- [ ] SC-005: No six/future/mock in dependencies
- [ ] SC-006: setup.py and setup.cfg deleted
- [ ] SC-007: tox runs successfully
